<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Pixel World - Mundo Online Mejorado</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            image-rendering: pixelated;
            image-rendering: -moz-crisp-edges;
            image-rendering: crisp-edges;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: 'Courier New', monospace;
            background: #2c5f2d;
            overflow: hidden;
            touch-action: none;
        }

        #loginScreen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(180deg, #87ceeb 0%, #97d07d 50%, #6b8e23 100%);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .login-box {
            background: #8b7355;
            border: 4px solid #654321;
            padding: 30px;
            box-shadow: 0 8px 0 #3d2817;
            max-width: 400px;
            width: 90%;
        }

        .login-box h1 {
            color: #fff;
            text-align: center;
            margin-bottom: 10px;
            font-size: 32px;
            text-shadow: 3px 3px 0 #000;
        }

        .login-box p {
            color: #f4e4c1;
            text-align: center;
            margin-bottom: 20px;
        }

        .input-group {
            margin-bottom: 15px;
        }

        .input-group input {
            width: 100%;
            padding: 12px;
            border: 3px solid #654321;
            background: #f4e4c1;
            color: #000;
            font-size: 16px;
            font-family: 'Courier New', monospace;
        }

        .btn {
            width: 100%;
            padding: 12px;
            border: 3px solid #654321;
            background: #6b8e23;
            color: #fff;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            margin-bottom: 10px;
            font-family: 'Courier New', monospace;
            text-transform: uppercase;
            transition: transform 0.1s;
        }

        .btn:active {
            transform: translateY(2px);
        }

        .btn-create {
            background: #8b4513;
        }

        .error-msg {
            color: #ff0000;
            text-align: center;
            margin-top: 10px;
            text-shadow: 1px 1px 0 #000;
        }

        #gameContainer {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
        }

        #gameCanvas {
            display: block;
            width: 100%;
            height: 100%;
            background: #6b8e23;
        }

        #hud {
            position: fixed;
            top: 10px;
            left: 10px;
            right: 10px;
            pointer-events: none;
            z-index: 100;
        }

        .hud-top {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
        }

        .hud-info {
            background: rgba(139, 115, 85, 0.9);
            border: 3px solid #654321;
            padding: 10px;
            color: #fff;
            pointer-events: auto;
        }

        .health-bar {
            width: 150px;
            height: 20px;
            background: #333;
            border: 2px solid #000;
            margin-top: 5px;
            position: relative;
        }

        .health-fill {
            height: 100%;
            background: linear-gradient(to bottom, #ff6b6b, #cc0000);
            width: 100%;
            transition: width 0.3s;
        }

        .stats {
            font-size: 12px;
            margin-top: 5px;
        }

        #chatBox {
            position: fixed;
            bottom: 160px;
            left: 10px;
            width: 300px;
            max-height: 200px;
            background: rgba(0, 0, 0, 0.7);
            border: 2px solid #654321;
            padding: 10px;
            overflow-y: auto;
            pointer-events: auto;
            color: #fff;
            font-size: 12px;
            display: none;
        }

        .chat-message {
            margin-bottom: 5px;
            word-wrap: break-word;
        }

        .chat-player {
            color: #ffff00;
            font-weight: bold;
        }

        #chatInput {
            position: fixed;
            bottom: 120px;
            left: 10px;
            width: 300px;
            padding: 8px;
            background: rgba(139, 115, 85, 0.9);
            border: 2px solid #654321;
            color: #fff;
            font-family: 'Courier New', monospace;
            display: none;
        }

        #inventory {
            position: fixed;
            bottom: 10px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 5px;
            pointer-events: auto;
        }

        .inventory-slot {
            width: 50px;
            height: 50px;
            background: rgba(139, 115, 85, 0.9);
            border: 3px solid #654321;
            position: relative;
            cursor: pointer;
        }

        .inventory-slot.active {
            border-color: #ffff00;
            box-shadow: 0 0 10px #ffff00;
        }

        .inventory-slot canvas {
            width: 100%;
            height: 100%;
        }

        .item-count {
            position: absolute;
            bottom: 2px;
            right: 4px;
            color: #fff;
            font-size: 10px;
            text-shadow: 1px 1px 0 #000;
            font-weight: bold;
        }

        #buildMenu {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(139, 115, 85, 0.95);
            border: 4px solid #654321;
            padding: 20px;
            display: none;
            z-index: 200;
            max-width: 500px;
            max-height: 80vh;
            overflow-y: auto;
            pointer-events: auto;
        }

        .build-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
            margin-top: 15px;
        }

        .build-item {
            background: #6b8e23;
            border: 3px solid #654321;
            padding: 10px;
            text-align: center;
            cursor: pointer;
            color: #fff;
            transition: background 0.2s;
        }

        .build-item:hover {
            background: #8b7355;
        }

        .build-item canvas {
            width: 40px;
            height: 40px;
            margin: 0 auto;
        }

        #characterMenu {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(139, 115, 85, 0.95);
            border: 4px solid #654321;
            padding: 20px;
            display: none;
            z-index: 200;
            max-width: 400px;
            pointer-events: auto;
        }

        .character-preview {
            text-align: center;
            margin-bottom: 20px;
        }

        #charPreview {
            border: 3px solid #654321;
            background: #6b8e23;
        }

        .customization-option {
            margin-bottom: 15px;
        }

        .customization-option label {
            color: #fff;
            display: block;
            margin-bottom: 5px;
        }

        .customization-option input,
        .customization-option select {
            width: 100%;
            padding: 8px;
            border: 2px solid #654321;
            background: #f4e4c1;
            font-family: 'Courier New', monospace;
        }

        #mobileControls {
            position: fixed;
            bottom: 80px;
            right: 10px;
            display: none;
            pointer-events: auto;
        }

        .joystick {
            width: 120px;
            height: 120px;
            background: rgba(139, 115, 85, 0.5);
            border: 3px solid #654321;
            border-radius: 60px;
            position: relative;
        }

        .joystick-inner {
            width: 50px;
            height: 50px;
            background: rgba(107, 142, 35, 0.8);
            border: 3px solid #654321;
            border-radius: 25px;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            transition: all 0.1s;
        }

        .action-buttons {
            position: fixed;
            bottom: 80px;
            left: 10px;
            display: none;
            gap: 10px;
            pointer-events: auto;
            flex-wrap: wrap;
        }

        .action-btn {
            width: 60px;
            height: 60px;
            background: rgba(139, 115, 85, 0.8);
            border: 3px solid #654321;
            border-radius: 30px;
            color: #fff;
            font-size: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.1s;
        }

        .action-btn:active {
            background: rgba(107, 142, 35, 0.8);
            transform: scale(0.95);
        }

        #menuButtons {
            position: fixed;
            top: 10px;
            right: 10px;
            display: flex;
            gap: 5px;
            pointer-events: auto;
            flex-wrap: wrap;
            max-width: 300px;
        }

        .menu-btn {
            padding: 10px 15px;
            background: rgba(139, 115, 85, 0.9);
            border: 3px solid #654321;
            color: #fff;
            cursor: pointer;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            transition: all 0.1s;
        }

        .menu-btn:active {
            background: rgba(107, 142, 35, 0.9);
            transform: translateY(2px);
        }

        #playersList {
            position: fixed;
            top: 100px;
            right: 10px;
            background: rgba(139, 115, 85, 0.9);
            border: 3px solid #654321;
            padding: 10px;
            max-width: 200px;
            max-height: 300px;
            overflow-y: auto;
            display: none;
            pointer-events: auto;
        }

        .player-item {
            color: #fff;
            padding: 5px;
            margin-bottom: 5px;
            border-bottom: 1px solid #654321;
            cursor: pointer;
            transition: background 0.2s;
        }

        .player-item:hover {
            background: rgba(107, 142, 35, 0.5);
        }

        #allianceMenu {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(139, 115, 85, 0.95);
            border: 4px solid #654321;
            padding: 20px;
            display: none;
            z-index: 200;
            max-width: 450px;
            pointer-events: auto;
            max-height: 80vh;
            overflow-y: auto;
        }

        .alliance-info {
            color: #fff;
            margin-bottom: 15px;
        }

        .alliance-members {
            max-height: 200px;
            overflow-y: auto;
            margin: 15px 0;
        }

        .member-item {
            color: #fff;
            padding: 8px;
            background: rgba(0, 0, 0, 0.3);
            margin-bottom: 5px;
            border: 2px solid #654321;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .alliance-list {
            max-height: 300px;
            overflow-y: auto;
            margin: 15px 0;
        }

        .alliance-item {
            color: #fff;
            padding: 10px;
            background: rgba(107, 142, 35, 0.3);
            margin-bottom: 5px;
            border: 2px solid #654321;
            cursor: pointer;
            transition: background 0.2s;
        }

        .alliance-item:hover {
            background: rgba(107, 142, 35, 0.5);
        }

        #shopMenu {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(139, 115, 85, 0.95);
            border: 4px solid #654321;
            padding: 20px;
            display: none;
            z-index: 200;
            max-width: 500px;
            max-height: 80vh;
            overflow-y: auto;
            pointer-events: auto;
        }

        .shop-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin-top: 15px;
        }

        .shop-item {
            background: #6b8e23;
            border: 3px solid #654321;
            padding: 10px;
            text-align: center;
            cursor: pointer;
            color: #fff;
            transition: background 0.2s;
        }

        .shop-item:hover {
            background: #8b7355;
        }

        .shop-price {
            color: #ffff00;
            font-weight: bold;
            margin-top: 5px;
        }

        .close-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            width: 30px;
            height: 30px;
            background: #cc0000;
            border: 2px solid #000;
            color: #fff;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            transition: all 0.1s;
        }

        .close-btn:hover {
            background: #ff0000;
        }

        #notifications {
            position: fixed;
            top: 80px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 300;
            pointer-events: none;
        }

        .notification {
            background: rgba(139, 115, 85, 0.9);
            border: 3px solid #654321;
            padding: 15px 20px;
            color: #fff;
            margin-bottom: 10px;
            animation: slideDown 0.3s ease;
        }

        @keyframes slideDown {
            from {
                transform: translateY(-100px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        #cameraControls {
            position: fixed;
            bottom: 220px;
            right: 10px;
            display: flex;
            flex-direction: column;
            gap: 5px;
            pointer-events: auto;
        }

        .camera-btn {
            width: 50px;
            height: 50px;
            background: rgba(139, 115, 85, 0.8);
            border: 3px solid #654321;
            border-radius: 25px;
            color: #fff;
            font-size: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.1s;
        }

        .camera-btn:active {
            background: rgba(107, 142, 35, 0.8);
            transform: scale(0.95);
        }

        #textureToggle {
            position: fixed;
            bottom: 10px;
            right: 10px;
            padding: 10px 15px;
            background: rgba(139, 115, 85, 0.9);
            border: 3px solid #654321;
            color: #fff;
            cursor: pointer;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            pointer-events: auto;
            transition: all 0.1s;
        }

        #textureToggle:active {
            transform: translateY(2px);
        }

        .loading {
            color: #fff;
            text-align: center;
        }

        h2, h3 {
            color: #fff;
            text-shadow: 2px 2px 0 #000;
            margin-bottom: 10px;
        }

        /* Efectos de part√≠culas */
        .magic-particle {
            position: absolute;
            pointer-events: none;
            z-index: 50;
        }

        .water-slow-effect {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: #1e90ff;
            font-size: 24px;
            text-shadow: 2px 2px 4px #000;
            pointer-events: none;
            z-index: 150;
            animation: fadeOut 1s forwards;
        }

        @keyframes fadeOut {
            to {
                opacity: 0;
                transform: translate(-50%, -60%);
            }
        }

        /* Responsive */
        @media (max-width: 768px) {
            #mobileControls,
            .action-buttons,
            #cameraControls {
                display: flex;
            }

            #inventory {
                bottom: 160px;
                flex-wrap: wrap;
                max-width: 90%;
            }

            .inventory-slot {
                width: 45px;
                height: 45px;
            }

            #chatBox {
                width: calc(100% - 20px);
                bottom: 230px;
            }

            #chatInput {
                width: calc(100% - 20px);
                bottom: 190px;
            }

            #buildMenu,
            #characterMenu,
            #allianceMenu,
            #shopMenu {
                max-width: 90%;
                max-height: 70vh;
            }

            #menuButtons {
                top: 80px;
                flex-direction: column;
                max-width: 150px;
            }

            #hud .hud-info {
                font-size: 11px;
            }

            .health-bar {
                width: 120px;
                height: 16px;
            }
        }

        @media (orientation: landscape) and (max-width: 926px) {
            #mobileControls {
                bottom: 10px;
                right: 150px;
            }

            .action-buttons {
                bottom: 10px;
                left: 10px;
                flex-direction: row;
            }

            #inventory {
                bottom: 10px;
                right: 300px;
                left: auto;
                transform: none;
            }

            #cameraControls {
                bottom: 10px;
                right: 10px;
            }

            #chatBox {
                bottom: 90px;
                max-width: 250px;
            }

            #chatInput {
                bottom: 50px;
                max-width: 250px;
            }

            #textureToggle {
                bottom: 80px;
            }
        }
    </style>
</head>
<body>
    <div id="loginScreen">
        <div class="login-box">
            <h1>üåç PIXEL WORLD</h1>
            <p>Mundo Multijugador Online</p>
            
            <div class="input-group">
                <input type="text" id="usernameInput" placeholder="NOMBRE DE USUARIO">
            </div>
            <div class="input-group">
                <input type="password" id="passwordInput" placeholder="CONTRASE√ëA">
            </div>
            
            <button class="btn" onclick="login()">ENTRAR AL MUNDO</button>
            <button class="btn btn-create" onclick="register()">CREAR PERSONAJE</button>
            
            <div id="loginError" class="error-msg"></div>
            <div class="loading" id="loginLoading" style="display:none;">Cargando mundo...</div>
        </div>
    </div>

    <div id="gameContainer">
        <canvas id="gameCanvas"></canvas>
        
        <div id="hud">
            <div class="hud-top">
                <div class="hud-info">
                    <div><strong id="playerNameHUD">Jugador</strong></div>
                    <div class="health-bar">
                        <div class="health-fill" id="healthBar"></div>
                    </div>
                    <div class="stats">
                        üí∞ Oro: <span id="goldAmount">0</span><br>
                        üë• Online: <span id="onlineCount">1</span>
                    </div>
                </div>
            </div>
        </div>

        <div id="menuButtons">
            <button class="menu-btn" onclick="toggleBuildMenu()">üèóÔ∏è CONSTRUIR</button>
            <button class="menu-btn" onclick="toggleCharacterMenu()">üë§ PERSONAJE</button>
            <button class="menu-btn" onclick="toggleShopMenu()">üõí TIENDA</button>
            <button class="menu-btn" onclick="toggleAllianceMenu()">‚öîÔ∏è ALIANZA</button>
            <button class="menu-btn" onclick="togglePlayersList()">üë• JUGADORES</button>
            <button class="menu-btn" onclick="toggleChat()">üí¨ CHAT</button>
        </div>

        <div id="chatBox"></div>
        <input type="text" id="chatInput" placeholder="Escribe un mensaje..." maxlength="100">

        <div id="inventory"></div>

        <div id="mobileControls">
            <div class="joystick" id="joystick">
                <div class="joystick-inner" id="joystickInner"></div>
            </div>
        </div>

        <div class="action-buttons">
            <button class="action-btn" id="actionBtn">‚öíÔ∏è</button>
            <button class="action-btn" id="attackBtn">‚öîÔ∏è</button>
            <button class="action-btn" id="magicBtn">‚ú®</button>
            <button class="action-btn" id="shovelBtn">ü•Ñ</button>
        </div>

        <div id="cameraControls">
            <button class="camera-btn" onclick="adjustZoom(0.1)">+</button>
            <button class="camera-btn" onclick="adjustZoom(-0.1)">‚àí</button>
        </div>

        <button id="textureToggle" onclick="toggleTextureMode()">üé® Texturas: Realista</button>

        <div id="buildMenu">
            <button class="close-btn" onclick="toggleBuildMenu()">‚úï</button>
            <h2>CONSTRUCCI√ìN</h2>
            <div class="build-grid" id="buildGrid"></div>
        </div>

        <div id="characterMenu">
            <button class="close-btn" onclick="toggleCharacterMenu()">‚úï</button>
            <h2>PERSONALIZAR</h2>
            <div class="character-preview">
                <canvas id="charPreview" width="128" height="128"></canvas>
            </div>
            <div class="customization-option">
                <label>Color de Piel:</label>
                <input type="color" id="skinColor" value="#ffcc99">
            </div>
            <div class="customization-option">
                <label>Color de Ropa:</label>
                <input type="color" id="clothesColor" value="#4169e1">
            </div>
            <div class="customization-option">
                <label>Cabello:</label>
                <select id="hairStyle">
                    <option value="none">Sin cabello</option>
                    <option value="short">Corto</option>
                    <option value="long">Largo</option>
                    <option value="spiky">Puntiagudo</option>
                </select>
                <input type="color" id="hairColor" value="#8b4513">
            </div>
            <div class="customization-option">
                <label>Poder M√°gico:</label>
                <select id="magicPower">
                    <option value="none">Ninguno</option>
                    <option value="fire">üî• Fuego</option>
                    <option value="water">üíß Agua</option>
                    <option value="earth">üåç Tierra</option>
                    <option value="wind">üí® Viento</option>
                    <option value="lightning">‚ö° Rayo</option>
                </select>
            </div>
            <button class="btn" onclick="saveCharacter()">GUARDAR</button>
        </div>

        <div id="allianceMenu">
            <button class="close-btn" onclick="toggleAllianceMenu()">‚úï</button>
            <h2>ALIANZAS</h2>
            <div class="alliance-info" id="allianceInfo">
                No tienes alianza
            </div>
            <button class="btn" onclick="createAlliance()">CREAR ALIANZA</button>
            <button class="btn" onclick="leaveAlliance()" style="background: #cc0000; display: none;" id="leaveAllianceBtn">SALIR DE ALIANZA</button>
            
            <h3 style="margin-top: 20px;">ALIANZAS DISPONIBLES</h3>
            <div class="alliance-list" id="allianceList"></div>
            
            <h3 style="margin-top: 20px;">MIEMBROS</h3>
            <div class="alliance-members" id="allianceMembers"></div>
        </div>

        <div id="shopMenu">
            <button class="close-btn" onclick="toggleShopMenu()">‚úï</button>
            <h2>TIENDA</h2>
            <div class="shop-grid" id="shopGrid"></div>
        </div>

        <div id="playersList">
            <h3>JUGADORES ONLINE</h3>
            <div id="playersListContent"></div>
        </div>

        <div id="notifications"></div>
    </div>

    <script type="module">
        // ==================== IMPORTACIONES FIREBASE ====================
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged, signOut, fetchSignInMethodsForEmail } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
import { getDatabase, ref, set, update, onValue, get, query, limitToLast, orderByChild } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

// ==================== CONFIGURACI√ìN FIREBASE ====================
const firebaseConfig = {
    apiKey: "AIzaSyA-9RhTn1DtZy14OlMvfhVPGVa96TAhFcY",
    authDomain: "pixel-world-d5dfb.firebaseapp.com",
    databaseURL: "https://pixel-world-d5dfb-default-rtdb.firebaseio.com",  // Aseg√∫rate de usar tu URL de Realtime Database
    projectId: "pixel-world-d5dfb",
    storageBucket: "pixel-world-d5dfb.firebasestorage.app",
    messagingSenderId: "335179075812",
    appId: "1:335179075812:web:31906616ca2cb53f0c1cf1",
    measurementId: "G-9Y2H0BSHYY"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getDatabase(app);

// ==================== VARIABLES GLOBALES ====================
let currentUser = null;
let currentUsername = null;
let canvas, ctx;
let gameRunning = false;
let players = new Map();
let allAlliances = new Map();
let worldData = {
    tiles: [],
    buildings: [],
    items: [],
    npcs: [],
    enemies: [],
    animals: [],
    dayTime: 0, // 0-23999, donde 0-12000 d√≠a, 12000-24000 noche
    sleepingPlayers: 0,
    onlinePlayers: 0
};

// ==================== FUNCI√ìN SHOW NOTIFICATION ====================
function showNotification(message) {
    const notifications = document.getElementById('notifications');
    if (!notifications) return;

    const notif = document.createElement('div');
    notif.className = 'notification';
    notif.textContent = message;
    notifications.appendChild(notif);

    setTimeout(() => {
        notif.remove();
    }, 3000);
}

// ==================== CONFIGURACI√ìN DEL MUNDO MEJORADA ====================
const TILE_SIZE = 16;
const WORLD_WIDTH = 300;
const WORLD_HEIGHT = 300;
const CHUNK_SIZE = 16;
const LAKE_MIN_SIZE = 8;
const LAKE_MAX_SIZE = 20;
const DAY_CYCLE_LENGTH = 24000; // 20 minutos reales si actualizamos cada 50ms (1200 ticks/min * 20 min)
const NIGHT_START = 12000;
const DAY_START = 0;

// ==================== CONFIGURACI√ìN DE TEXTURAS ====================
let textureMode = 'realistic'; // 'realistic' o 'minimal'
let currentZoom = 1;
const MIN_ZOOM = 0.5;
const MAX_ZOOM = 2.5;

// ==================== JUGADOR LOCAL ====================
let localPlayer = {
    x: WORLD_WIDTH * TILE_SIZE / 2,
    y: WORLD_HEIGHT * TILE_SIZE / 2,
    vx: 0,
    vy: 0,
    speed: 3,
    baseSpeed: 3,
    health: 100,
    maxHealth: 100,
    gold: 100,
    inventory: [],
    customization: {
        skinColor: '#ffcc99',
        clothesColor: '#4169e1',
        hairStyle: 'short',
        hairColor: '#8b4513',
        magicPower: 'none'
    },
    selectedSlot: 0,
    alliance: null,
    isInWater: false,
    animation: {
        frame: 0,
        time: 0,
        walking: false
    }
};

// ==================== C√ÅMARA ====================
let camera = {
    x: 0,
    y: 0,
    width: 0,
    height: 0,
    shake: 0
};

// ==================== CONTROL ====================
let keys = {};
let mouseX = 0;
let mouseY = 0;
let joystickActive = false;
let joystickDelta = { x: 0, y: 0 };

// ==================== EFECTOS Y PART√çCULAS ====================
let particles = [];
let magicEffects = [];

// ==================== LISTENERS DE FIREBASE ====================
let playersListener = null;
let worldListener = null;
let alliancesListener = null;
let timeListener = null;
let enemiesListener = null;
let animalsListener = null;
let chatListener = null;

// ==================== AUTENTICACI√ìN ====================
window.register = async function() {
    const username = document.getElementById('usernameInput').value.trim();
    const password = document.getElementById('passwordInput').value;
    const errorDiv = document.getElementById('loginError');

    if (!username || !password) {
        errorDiv.textContent = 'Completa todos los campos';
        return;
    }

    if (username.length < 3) {
        errorDiv.textContent = 'Usuario muy corto (m√≠nimo 3 caracteres)';
        return;
    }

    if (password.length < 6) {
        errorDiv.textContent = 'Contrase√±a muy corta (m√≠nimo 6 caracteres)';
        return;
    }

    try {
        const email = `${username.toLowerCase().replace(/[^a-z0-9]/g, '')}@pixelworld.com`;
        const methods = await fetchSignInMethodsForEmail(auth, email);
        
        if (methods.length > 0) {
            errorDiv.textContent = 'Usuario ya existe';
            return;
        }

        const userCredential = await createUserWithEmailAndPassword(auth, email, password);
        
        await set(ref(db, "pixelworld_players/" + userCredential.user.uid), {
            username: username,
            x: WORLD_WIDTH * TILE_SIZE / 2,
            y: WORLD_HEIGHT * TILE_SIZE / 2,
            health: 100,
            gold: 100,
            customization: localPlayer.customization,
            inventory: [],
            alliance: null,
            online: true,
            lastUpdate: Date.now()
        });
        
        errorDiv.textContent = '';
        showNotification('¬°Cuenta creada! Bienvenido a Pixel World');
    } catch (error) {
        console.error('Error:', error);
        errorDiv.textContent = 'Error al crear cuenta';
    }
};

window.login = async function() {
    const username = document.getElementById('usernameInput').value.trim();
    const password = document.getElementById('passwordInput').value;
    const errorDiv = document.getElementById('loginError');

    if (!username || !password) {
        errorDiv.textContent = 'Completa todos los campos';
        return;
    }

    document.getElementById('loginLoading').style.display = 'block';

    try {
        const email = `${username.toLowerCase().replace(/[^a-z0-9]/g, '')}@pixelworld.com`;
        await signInWithEmailAndPassword(auth, email, password);
        errorDiv.textContent = '';
    } catch (error) {
        document.getElementById('loginLoading').style.display = 'none';
        errorDiv.textContent = 'Usuario o contrase√±a incorrectos';
        console.error('Error login:', error);
    }
};

onAuthStateChanged(auth, async (user) => {
    if (user) {
        currentUser = user;
        try {
            const playerSnap = await get(ref(db, "pixelworld_players/" + user.uid));
            if (playerSnap.exists()) {
                const data = playerSnap.val();
                currentUsername = data.username;
                localPlayer.x = data.x || localPlayer.x;
                localPlayer.y = data.y || localPlayer.y;
                localPlayer.health = data.health || 100;
                localPlayer.gold = data.gold || 100;
                localPlayer.customization = data.customization || localPlayer.customization;
                localPlayer.inventory = data.inventory || [];
                localPlayer.alliance = data.alliance || null;
                
                await update(ref(db, "pixelworld_players/" + user.uid), {
                    online: true,
                    lastUpdate: Date.now()
                });
                
                startGame();
            }
        } catch (error) {
            console.error("Error cargando jugador:", error);
        }
    }
});

// ==================== INICIO DEL JUEGO ====================
function startGame() {
    document.getElementById('loginScreen').style.display = 'none';
    document.getElementById('gameContainer').style.display = 'block';
    
    canvas = document.getElementById('gameCanvas');
    ctx = canvas.getContext('2d');
    ctx.imageSmoothingEnabled = false;
    
    resizeCanvas();
    window.addEventListener('resize', resizeCanvas);
    
    setupControls();
    loadWorld();
    setupInventory();
    setupShop();
    setupBuildMenu();
    
    document.getElementById('playerNameHUD').textContent = currentUsername;
    updateHUD();
    
    listenToPlayers();
    listenToAlliances();
    listenToChat();
    listenToWorld();
    listenToTime();
    listenToEnemies();
    listenToAnimals();
    
    gameRunning = true;
    gameLoop();
    dayCycleLoop();
    
    setInterval(updatePlayerPosition, 100);
    setInterval(syncWithServer, 5000);
    
    showNotification('¬°Bienvenido a Pixel World! Usa WASD para moverte');
}

function resizeCanvas() {
    canvas.width = window.innerWidth;
    canvas.height = window.innerHeight;
    camera.width = canvas.width;
    camera.height = canvas.height;
}

// ==================== CARGAR MUNDO PERSISTENTE ====================
async function loadWorld() {
    const worldSnap = await get(ref(db, 'world'));
    if (worldSnap.exists()) {
        const data = worldSnap.val();
        worldData.tiles = data.tiles || generateInitialTiles();
        worldData.buildings = data.buildings || [];
        worldData.items = data.items || [];
        worldData.npcs = data.npcs || [];
        worldData.enemies = data.enemies || [];
        worldData.animals = data.animals || [];
        worldData.dayTime = data.dayTime || 0;
    } else {
        worldData.tiles = generateInitialTiles();
        await set(ref(db, 'world/tiles'), worldData.tiles);
    }
}

function generateInitialTiles() {
    let tiles = [];
    for (let y = 0; y < WORLD_HEIGHT; y++) {
        tiles[y] = [];
        for (let x = 0; x < WORLD_WIDTH; x++) {
            tiles[y][x] = { type: 'grass', walkable: true };
        }
    }
    
    // Generar lagos
    const numLakes = 8;
    for (let i = 0; i < numLakes; i++) {
        const lakeX = Math.floor(Math.random() * (WORLD_WIDTH - 30)) + 15;
        const lakeY = Math.floor(Math.random() * (WORLD_HEIGHT - 30)) + 15;
        const lakeSize = Math.floor(Math.random() * (LAKE_MAX_SIZE - LAKE_MIN_SIZE)) + LAKE_MIN_SIZE;
        
        generateLake(lakeX, lakeY, lakeSize, tiles);
    }
    
    // Generar √°rboles revueltos
    const numTrees = 300;
    for (let i = 0; i < numTrees; i++) {
        const treeX = Math.floor(Math.random() * WORLD_WIDTH);
        const treeY = Math.floor(Math.random() * WORLD_HEIGHT);
        if (tiles[treeY][treeX].type === 'grass' && Math.random() > 0.8) {
            tiles[treeY][treeX] = { type: 'tree', walkable: false, resource: 'wood', health: 3 };
        }
    }
    
    // Generar rocas
    const numRocks = 200;
    for (let i = 0; i < numRocks; i++) {
        const rockX = Math.floor(Math.random() * WORLD_WIDTH);
        const rockY = Math.floor(Math.random() * WORLD_HEIGHT);
        if (tiles[rockY][rockX].type === 'grass' && Math.random() > 0.9) {
            tiles[rockY][rockX] = { type: 'stone', walkable: false, resource: 'stone', health: 5 };
        }
    }
    
    // Generar dirt patches
    const numDirt = 25;
    for (let i = 0; i < numDirt; i++) {
        const dirtX = Math.floor(Math.random() * (WORLD_WIDTH - 10)) + 5;
        const dirtY = Math.floor(Math.random() * (WORLD_HEIGHT - 10)) + 5;
        const dirtSize = Math.floor(Math.random() * 5) + 3;
        
        generateDirtPatch(dirtX, dirtY, dirtSize, tiles);
    }
    
    return tiles;
}

// Funciones de generaci√≥n actualizadas para aceptar tiles como par√°metro
function generateLake(centerX, centerY, size, tiles) {
    for (let y = -size; y <= size; y++) {
        for (let x = -size; x <= size; x++) {
            const distance = Math.sqrt(x * x + y * y);
            const tileX = centerX + x;
            const tileY = centerY + y;
            
            if (tileX >= 0 && tileX < WORLD_WIDTH && tileY >= 0 && tileY < WORLD_HEIGHT) {
                if (distance <= size * (0.7 + Math.random() * 0.3)) {
                    tiles[tileY][tileX] = { 
                        type: 'water', 
                        walkable: true,
                        slowdown: 0.5 
                    };
                }
            }
        }
    }
}

function generateDirtPatch(centerX, centerY, size, tiles) {
    for (let y = -size; y <= size; y++) {
        for (let x = -size; x <= size; x++) {
            const tileX = centerX + x;
            const tileY = centerY + y;
            
            if (tileX >= 0 && tileX < WORLD_WIDTH && tileY >= 0 && tileY < WORLD_HEIGHT) {
                if (tiles[tileY][tileX].type === 'grass' && Math.random() > 0.4) {
                    tiles[tileY][tileX] = { 
                        type: 'dirt', 
                        walkable: true 
                    };
                }
            }
        }
    }
}

// ==================== ESCUCHAR MUNDO ====================
function listenToWorld() {
    onValue(ref(db, 'world'), (snapshot) => {
        const data = snapshot.val();
        worldData.tiles = data.tiles || worldData.tiles;
        worldData.buildings = data.buildings || worldData.buildings;
        worldData.items = data.items || worldData.items;
        worldData.npcs = data.npcs || worldData.npcs;
        worldData.enemies = data.enemies || worldData.enemies;
        worldData.animals = data.animals || worldData.animals;
        worldData.dayTime = data.dayTime || worldData.dayTime;
        worldData.sleepingPlayers = data.sleepingPlayers || 0;
    });
}

// ==================== CICLO D√çA/NOCHE ====================
function dayCycleLoop() {
    setInterval(() => {
        worldData.dayTime = (worldData.dayTime + 1) % DAY_CYCLE_LENGTH;
        update(ref(db, 'world'), { dayTime: worldData.dayTime });
        
        if (worldData.dayTime === NIGHT_START) {
            spawnEnemies();
        } else if (worldData.dayTime === DAY_START) {
            worldData.enemies = [];
            update(ref(db, 'world'), { enemies: null });
        }
        
        // Chequear si dormir pasa la noche
        if (worldData.dayTime > NIGHT_START && worldData.sleepingPlayers >= Math.min(5, Math.ceil(worldData.onlinePlayers / 2))) {
            worldData.dayTime = DAY_START;
            worldData.sleepingPlayers = 0;
            update(ref(db, 'world'), { dayTime: worldData.dayTime, sleepingPlayers: 0 });
            showNotification('¬°Todos durmieron! Amanecer acelerado.');
        }
    }, 50); // Actualiza cada 50ms para ciclo suave
}

// ==================== SPAWN ENEMIGOS ====================
function spawnEnemies() {
    worldData.enemies = [];
    for (let i = 0; i < 20; i++) {
        const enemyX = Math.random() * WORLD_WIDTH * TILE_SIZE;
        const enemyY = Math.random() * WORLD_HEIGHT * TILE_SIZE;
        const tileX = Math.floor(enemyX / TILE_SIZE);
        const tileY = Math.floor(enemyY / TILE_SIZE);
        
        if (worldData.tiles[tileY][tileX].type === 'grass') {
            worldData.enemies.push({
                id: 'enemy_' + i,
                x: enemyX,
                y: enemyY,
                type: Math.random() > 0.5 ? 'zombie' : 'mage',
                health: 50,
                maxHealth: 50
            });
        }
    }
    update(ref(db, 'world'), { enemies: worldData.enemies });
}

// ==================== SPAWN ANIMALES ====================
function spawnAnimals() {
    worldData.animals = [];
    for (let i = 0; i < 30; i++) {
        const animalX = Math.random() * WORLD_WIDTH * TILE_SIZE;
        const animalY = Math.random() * WORLD_HEIGHT * TILE_SIZE;
        const tileX = Math.floor(animalX / TILE_SIZE);
        const tileY = Math.floor(animalY / TILE_SIZE);
        
        if (worldData.tiles[tileY][tileX].type === 'grass') {
            worldData.animals.push({
                id: 'animal_' + i,
                x: animalX,
                y: animalY,
                type: 'cow', // Ejemplo, puedes a√±adir m√°s tipos
                health: 30,
                maxHealth: 30
            });
        }
    }
    update(ref(db, 'world'), { animals: worldData.animals });
}

// ==================== ESCUCHAR TIEMPO ====================
function listenToTime() {
    onValue(ref(db, 'world/dayTime'), (snap) => {
        worldData.dayTime = snap.val() || 0;
    });
    onValue(ref(db, 'world/sleepingPlayers'), (snap) => {
        worldData.sleepingPlayers = snap.val() || 0;
    });
}

// ==================== ESCUCHAR ENEMIGOS ====================
function listenToEnemies() {
    onValue(ref(db, 'world/enemies'), (snap) => {
        worldData.enemies = snap.val() || [];
    });
}

// ==================== ESCUCHAR ANIMALES ====================
function listenToAnimals() {
    onValue(ref(db, 'world/animals'), (snap) => {
        worldData.animals = snap.val() || [];
    });
}

// ==================== CONTROLES ====================
function setupControls() {
    // [El c√≥digo de setupControls se mantiene, a√±adir click para puertas y cofres]
    canvas.addEventListener('click', (e) => {
        const worldX = (camera.x + mouseX) / currentZoom;
        const worldY = (camera.y + mouseY) / currentZoom;
        handleWorldClick(worldX, worldY);
    });
}

// ==================== HANDLE CLICK ====================
function handleWorldClick(worldX, worldY) {
    const tileX = Math.floor(worldX / TILE_SIZE);
    const tileY = Math.floor(worldY / TILE_SIZE);
    
    // Construir si en modo build
    if (document.getElementById('buildMenu').style.display === 'block') {
        const selected = localPlayer.inventory[localPlayer.selectedSlot];
        if (selected && selected.type === 'wall' || selected.type === 'door' || selected.type === 'chest') {
            buildAt(tileX, tileY, selected.type);
        }
    } else {
        // Interactuar con puertas
        worldData.buildings.forEach(building => {
            if (building.x / TILE_SIZE === tileX && building.y / TILE_SIZE === tileY && building.type === 'door') {
                building.open = !building.open;
                update(ref(db, 'world/buildings/' + building.id), { open: building.open });
            }
        });
        
        // Abrir cofre
        worldData.buildings.forEach(building => {
            if (building.x / TILE_SIZE === tileX && building.y / TILE_SIZE === tileY && building.type === 'chest') {
                openChestMenu(building);
            }
        });
    }
}

// ==================== CONSTRUIR ====================
function buildAt(tileX, tileY, type) {
    if (worldData.tiles[tileY][tileX].type !== 'grass') return;
    
    const building = {
        id: Date.now() + Math.random(),
        type: type,
        x: tileX * TILE_SIZE,
        y: tileY * TILE_SIZE,
        owner: currentUser.uid,
        open: false, // Para puertas
        inventory: [] // Para cofres
    };
    
    worldData.buildings.push(building);
    update(ref(db, 'world/buildings/' + building.id), building);
    
    worldData.tiles[tileY][tileX].walkable = false;
    update(ref(db, 'world/tiles/' + tileY + '/' + tileX), worldData.tiles[tileY][tileX]);
}

// ==================== ABRIR MENU COFRE ====================
function openChestMenu(chest) {
    // Crear menu temporal para cofre
    const menu = document.createElement('div');
    menu.style.position = 'fixed';
    menu.style.top = '50%';
    menu.style.left = '50%';
    menu.style.transform = 'translate(-50%, -50%)';
    menu.style.background = 'rgba(139, 115, 85, 0.95)';
    menu.style.border = '4px solid #654321';
    menu.style.padding = '20px';
    menu.style.zIndex = '200';
    menu.innerHTML = '<h2>COFRE</h2><div id="chestInventory"></div>';
    document.body.appendChild(menu);
    
    // Mostrar inventario del cofre
    const chestInv = document.getElementById('chestInventory');
    chest.inventory.forEach((item, i) => {
        const slot = document.createElement('div');
        slot.className = 'inventory-slot';
        // A√±adir item
        // ...
    });
    
    // Cerrar menu
    menu.addEventListener('click', () => menu.remove());
}

// ==================== DORMIR EN CAMA ====================
function sleepInBed() {
    if (worldData.dayTime > NIGHT_START) {
        worldData.sleepingPlayers++;
        update(ref(db, 'world'), { sleepingPlayers: worldData.sleepingPlayers });
        showNotification('Durmiendo...');
    }
}

// ==================== FUEGO AMIGO ====================
function attackPlayer(targetPlayer) {
    targetPlayer.health -= 10;
    // Sincronizar
    update(ref(db, 'players/' + targetPlayer.id), { health: targetPlayer.health });
}

// ==================== MATAR ANIMAL ====================
function killAnimal(animal) {
    localPlayer.inventory.push({ type: 'meat', count: 1 });
    worldData.animals = worldData.animals.filter(a => a.id !== animal.id);
    update(ref(db, 'world'), { animals: worldData.animals });
}

// ==================== COCINAR EN FOGATA ====================
function cookAtCampfire() {
    // L√≥gica para cocinar carne
}

// ==================== DEFINIR ZONA COMO ALDEA ====================
function defineVillage(area) {
    // L√≥gica para marcar zona como aldea en DB
}

// ==================== ARREGLAR ALIANZAS ====================
function listenToAlliances() {
    onValue(ref(db, 'pixelworld_alliances'), (snap) => {
        allAlliances.clear();
        const data = snap.val();
        for (let id in data) {
            allAlliances.set(id, data[id]);
        }
        updateAllianceList();
    });
}

// A√±adir invitaciones y solicitudes en menus

// ==================== RENDER CON CICLO D√çA/NOCHE ====================
function render() {
    // A√±adir overlay de oscuridad para noche
    const darkness = 1 - (Math.min(Math.max(worldData.dayTime - NIGHT_START, 0), DAY_CYCLE_LENGTH - NIGHT_START) / (DAY_CYCLE_LENGTH - NIGHT_START));
    ctx.fillStyle = `rgba(0, 0, 0, ${darkness * 0.8})`;
    ctx.fillRect(0, 0, canvas.width, canvas.height);
    
    // Resto del render...
    
    // Render enemigos y animales
    worldData.enemies.forEach(enemy => {
        // Draw enemy
    });
    
    worldData.animals.forEach(animal => {
        // Draw animal
    });
}

// ==================== CAN WALK CON F√çSICAS ====================
function canWalk(x, y) {
    const tileX = Math.floor(x / TILE_SIZE);
    const tileY = Math.floor(y / TILE_SIZE);
    
    if (tileX < 0 || tileX >= WORLD_WIDTH || tileY < 0 || tileY >= WORLD_HEIGHT) return false;
    
    const tile = worldData.tiles[tileY][tileX];
    
    if (tile.type === 'water') return true;
    
    // Chequear buildings
    for (let building of worldData.buildings) {
        if (building.x / TILE_SIZE === tileX && building.y / TILE_SIZE === tileY) {
            if (building.type === 'wall' || (building.type === 'door' && !building.open)) return false;
        }
    }
    
    return tile.walkable;
}

// ==================== ESCUCHAR CHAT ====================
function listenToChat() {
    const chatRef = query(ref(db, "pixelworld_chat"), orderByChild('timestamp'), limitToLast(50));
    onValue(chatRef, (snapshot) => {
        snapshot.forEach((child) => {
            const data = child.val();
            if (data.userId !== currentUser.uid) {
                addChatMessage(data.username, data.message);
            }
        });
    });
}

// ==================== [Resto del c√≥digo adaptado similarmente] ===
</script>
</body>
</html>
